<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cook County Policy Simulator (POL-681MD)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { background-color: #F8F9FA; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .brutal-border { border: 2px solid #000; box-shadow: 4px 4px 0px 0px rgba(0,0,0,1); }
        .brutal-border-sm { border: 2px solid #000; box-shadow: 2px 2px 0px 0px rgba(0,0,0,1); }
        .brutal-hover:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px 0px rgba(0,0,0,1); }
        .brutal-active:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px 0px rgba(0,0,0,1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICON SYSTEM (Inline SVG fallback for Lucide) ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const icons = {
                Building2: <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2 M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2 M10 6h4 M10 10h4 M10 14h4 M10 18h4" />,
                Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />,
                CheckCircle2: <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M9 12l2 2 4-4" />,
                HelpCircle: <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3 M12 17h.01" />,
                LayoutDashboard: <rect width="7" height="9" x="3" y="3" rx="1" /><rect width="7" height="5" x="14" y="3" rx="1" /><rect width="7" height="9" x="14" y="12" rx="1" /><rect width="7" height="5" x="3" y="16" rx="1" />,
                X: <path d="M18 6 6 18 M6 6l12 12" />,
                Key: <path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4 M21 2l-9.6 9.6 M2 12a5 5 0 0 0 5 5h0a5 5 0 0 0 5-5h0a5 5 0 0 0-5-5h0a5 5 0 0 0-5 5Z" />,
                Trash2: <path d="M3 6h18 M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6 M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2 M10 11v6 M14 11v6" />,
                Bot: <path d="M12 8V4H8 M20 14h2 M2 14h2 M15 13v2 M9 13v2 M12 13v2" /><rect width="16" height="12" x="4" y="8" rx="2" />,
                GitPullRequest: <circle cx="18" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><path d="M13 6h3a2 2 0 0 1 2 2v7"/><line x1="6" x2="6" y1="9" y2="21"/>,
                PlayCircle: <circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/>,
                ChevronRight: <path d="m9 18 6-6-6-6"/>,
                Sprout: <path d="M7 20h10 M10 20c5.5-2.5.8-6.4 3-10 M9.5 9.4c1.1.8 1.8 2.2 2.3 3.7-2 .4-3.5.4-4.8-.3-1.2-.6-2.3-1.9-3-4.2 2.8-.5 4.4 0 5.5.8z M14.1 6a7 7 0 0 0-1.1 4c1.9-.1 3.3-.6 4.3-1.4 1-1 1.6-2.3 1.7-4.6-2.7.1-4 1-4.9 2z"/>,
                Users: <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M16 3.13a4 4 0 0 1 0 7.75 M22 21v-2a4 4 0 0 0-3-3.87 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>,
                Briefcase: <rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>,
                TrendingUp: <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/>,
                Loader2: <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        /* --- DATA & CONFIG --- */
        const DEMO_PROPOSAL = "Mandate that all new data centers over 50MW in Cook County must source 100% of their electricity from NEW local renewable energy projects (additionality) within 5 years of operation.";

        const STAKEHOLDERS = [
            { id: "env_dept", role: "Cook County Dept. of Environment", icon: "Sprout", desc: "Focus: Climate Action Plan, Energy, Water & Carbon Neutrality", defaultModel: "Gemini 2.5 Pro", color: "text-emerald-600", bg: "bg-emerald-50" },
            { id: "perro", role: "PERRO (Community Organizer)", icon: "Users", desc: "Focus: Environmental Justice, Pilsen, Air Quality, Equity", defaultModel: "Gemini 2.5 Flash", color: "text-amber-600", bg: "bg-amber-50" },
            { id: "ibew", role: "IBEW Union Rep", icon: "Briefcase", desc: "Focus: Skilled Trades, Construction Jobs, Worker Safety", defaultModel: "Gemini 2.5 Flash", color: "text-blue-600", bg: "bg-blue-50" },
            { id: "econ_dev", role: "Economic Development Bureau", icon: "TrendingUp", desc: "Focus: Tax Base, Tech Hub Status, Regional Competitiveness", defaultModel: "Gemini 2.5 Pro", color: "text-purple-600", bg: "bg-purple-50" }
        ];

        const DEMO_RESULT = {
            responses: [
                { id: "env_dept", stance: "approval", score: 95, content: "This 'additionality' clause is the gold standard. It prevents companies from just buying cheap RECs from Texas while polluting here. It aligns perfectly with the Cook County Clean Energy Plan.", notes: "This is exactly what we need to hit our 2030 targets. No loopholes." },
                { id: "perro", stance: "skeptical", score: 45, content: "Clean energy is good, but where are these solar farms going? If they put them on brownfields in our neighborhood without cleaning them up first, we object. We also need to ensure residential rates don't hike up to pay for this infrastructure.", notes: "Rich tech companies get solar, we get the bill? Need price protections." },
                { id: "ibew", stance: "approval", score: 90, content: "Building new local wind and solar infrastructure means thousands of man-hours for Local 134. We support this 100%, provided the construction is Project Labor Agreement (PLA) mandated.", notes: "Green energy = Green backs. As long as it's union built." },
                { id: "econ_dev", stance: "objection", score: 30, content: "The 5-year timeline is unrealistic. Indiana offers 100% dirty power for 40% less cost. We will lose the next 3 hyperscale bids immediately. We need a 10-year ramp or tax offsets.", notes: "We are going to lose the Amazon HQ2 equivalent of data centers if we do this." }
            ],
            conflict: "Environmental Integrity (Additionality) vs. Regional Economic Competitiveness.",
            synthesis: "EDUCATIONAL SYNTHESIS:\n\nThe core tension is between the Environmental Department's need for 'real' zero-carbon energy and the Economic Bureau's fear of losing bids to neighboring states with cheaper, dirtier grids.\n\nPOSSIBLE STRATEGIES FOR STUDENT:\n1. Keep the mandate but extend the timeline to 7-10 years (Compromise).\n2. Keep the 5-year timeline but offer heavier tax incentives to offset the cost difference (Economic appeasement).\n3. Stand firm on 5 years, arguing that a 'Green Premium' attracts top-tier tech firms (Brand argument)."
        };

        const MOCK_HISTORY = [
            {
                id: 1,
                title: "South Side Water Cooling Restrictions",
                date: "2024-03-15",
                status: "Simulated",
                summary: "Restricts potable water use for data center cooling in residential zones. Mandates greywater recycling systems for facilities >50MW."
            },
            {
                id: 2,
                title: "Grid Additionality Mandate (Demo)",
                date: "2024-04-02",
                status: "Draft",
                summary: "Requires 100% local renewable sourcing for new hyperscale facilities within 5 years."
            }
        ];

        // --- COMPONENTS ---

        const Header = ({ setView, setShowHelp, setShowSettings, apiKey }) => (
            <header className="bg-white border-b-2 border-black sticky top-0 z-20">
                <div className="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
                    <div className="flex items-center gap-3 cursor-pointer group" onClick={() => setView('landing')}>
                        <div className="w-12 h-12 bg-[#00A3E0] flex items-center justify-center brutal-border transition-transform group-hover:translate-y-1 group-hover:shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                            <Icon name="Building2" size={28} className="text-white" />
                        </div>
                        <div>
                            <h1 className="font-bold text-xl tracking-tight leading-none text-black">COOK<span className="text-[#00A3E0]">SIMULATOR</span></h1>
                            <p className="text-xs font-mono font-medium text-gray-500 mt-1">POL-681MD: Stakeholder Tool</p>
                        </div>
                    </div>
                    <nav className="flex items-center gap-4 md:gap-6">
                        {/* API Key Status Indicator */}
                        <button onClick={() => setShowSettings(true)} className="flex items-center gap-2 text-sm font-bold text-gray-600 hover:text-black transition-colors bg-gray-50 border border-gray-200 px-3 py-1.5 rounded-md hover:bg-gray-100">
                            <Icon name="Settings" size={16} /> 
                            <span className="hidden sm:inline">Settings</span>
                            {apiKey ? (
                                <span className="flex items-center gap-1 text-[10px] uppercase tracking-wider font-bold text-emerald-700 bg-emerald-100 px-2 py-0.5 rounded border border-emerald-300 ml-1">
                                    <Icon name="CheckCircle2" size={12} /> Key Active
                                </span>
                            ) : (
                                <span className="flex items-center gap-1 text-[10px] uppercase tracking-wider font-bold text-amber-700 bg-amber-100 px-2 py-0.5 rounded border border-amber-300 ml-1">
                                    Demo Mode
                                </span>
                            )}
                        </button>
                        
                        <button onClick={() => setShowHelp(true)} className="flex items-center gap-2 text-sm font-bold text-gray-600 hover:text-black transition-colors hidden sm:flex">
                            <Icon name="HelpCircle" size={16} /> How to Use
                        </button>
                        <div className="h-6 w-px bg-gray-300 hidden md:block"></div>
                        <button onClick={() => setView('landing')} className="hidden md:flex items-center gap-2 text-sm font-bold hover:text-[#00A3E0] transition-colors">
                            <Icon name="LayoutDashboard" size={16} /> Case Studies
                        </button>
                    </nav>
                </div>
            </header>
        );

        const SettingsModal = ({ apiKey, setApiKey, onClose }) => {
            const [localKey, setLocalKey] = useState(apiKey);
            const [showSavedMsg, setShowSavedMsg] = useState(false);

            const handleSave = () => {
                setApiKey(localKey);
                setShowSavedMsg(true);
                setTimeout(() => {
                    setShowSavedMsg(false);
                    onClose();
                }, 1000);
            };

            const handleClear = () => {
                setLocalKey("");
                setApiKey("");
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                    <div className="bg-white max-w-md w-full brutal-border flex flex-col">
                        <div className="p-4 border-b-2 border-black flex justify-between items-center bg-[#F8F9FA]">
                            <h2 className="text-lg font-black flex items-center gap-2">
                                <Icon name="Settings" className="text-[#00A3E0]" /> Settings
                            </h2>
                            <button onClick={onClose} className="p-1 hover:bg-gray-200 rounded-lg transition-colors"><Icon name="X" /></button>
                        </div>
                        <div className="p-6 space-y-4">
                            <div>
                                <label className="block text-sm font-bold mb-2 flex items-center justify-between">
                                    <span className="flex items-center gap-2"><Icon name="Key" size={16} /> Gemini API Key</span>
                                    {localKey && (
                                        <button onClick={handleClear} className="text-xs text-red-500 hover:text-red-700 flex items-center gap-1 font-normal">
                                            <Icon name="Trash2" size={12} /> Clear Key
                                        </button>
                                    )}
                                </label>
                                <input
                                    type="password"
                                    value={localKey}
                                    onChange={(e) => setLocalKey(e.target.value)}
                                    placeholder="AIzaSy..."
                                    className="w-full bg-[#F0F4F8] border-2 border-gray-300 p-3 text-sm focus:border-[#00A3E0] outline-none font-mono"
                                />
                                <p className="text-xs text-gray-500 mt-2">
                                    Your key is saved securely in your browser's Local Storage. Leave blank to use pre-loaded demo data.
                                </p>
                            </div>
                            
                            {showSavedMsg && (
                                <div className="p-2 bg-emerald-50 border border-emerald-200 text-emerald-700 text-sm font-bold rounded flex items-center gap-2">
                                    <Icon name="CheckCircle2" size={16} /> Settings saved successfully!
                                </div>
                            )}
                        </div>
                        <div className="p-4 border-t-2 border-black bg-gray-50 flex justify-end gap-3">
                            <button onClick={onClose} className="text-gray-600 font-bold px-4 py-2 hover:bg-gray-200 transition-colors">Cancel</button>
                            <button onClick={handleSave} className="bg-black text-white px-6 py-2 font-bold brutal-border-sm brutal-hover brutal-active transition-all">Save & Close</button>
                        </div>
                    </div>
                </div>
            );
        };

        const HelpModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in duration-200">
                <div className="bg-white max-w-2xl w-full brutal-border flex flex-col max-h-[90vh]">
                    <div className="p-6 border-b-2 border-black flex justify-between items-center bg-[#F8F9FA]">
                        <div>
                            <h2 className="text-xl font-black flex items-center gap-2">
                                <Icon name="Bot" className="text-[#00A3E0]" size={24} /> Simulation Guide
                            </h2>
                            <p className="text-sm text-gray-500">For POL-681MD Students</p>
                        </div>
                        <button onClick={onClose} className="p-2 hover:bg-gray-200 transition-colors"><Icon name="X" size={24} /></button>
                    </div>
                    <div className="p-6 overflow-y-auto space-y-6">
                        <div className="space-y-2">
                            <h3 className="font-bold text-lg text-[#00A3E0]">1. Analyze</h3>
                            <p className="text-gray-600 text-sm leading-relaxed">Input your policy draft. Set stakeholder weights (influence) via the sliders. The AI acts as the 4 stakeholders based on their real-world mandates.</p>
                        </div>
                        <div className="space-y-2">
                            <h3 className="font-bold text-lg text-[#00A3E0]">2. Reflect</h3>
                            <p className="text-gray-600 text-sm leading-relaxed">The simulation pauses after generating stakeholder feedback. You must identify the key conflict and write a brief synthesis memo.</p>
                        </div>
                        <div className="space-y-2">
                            <h3 className="font-bold text-lg text-[#00A3E0]">3. Compare</h3>
                            <p className="text-gray-600 text-sm leading-relaxed">After submitting your reflection, the "AI Coordinator's Model Answer" is revealed to compare your conflict resolution logic.</p>
                        </div>
                    </div>
                    <div className="p-6 border-t-2 border-black bg-gray-50 flex justify-end">
                        <button onClick={onClose} className="bg-black text-white px-6 py-2 font-bold brutal-border-sm brutal-hover brutal-active transition-all">Got It</button>
                    </div>
                </div>
            </div>
        );

        const WorkflowStepper = ({ step }) => {
            const steps = [
                { num: 1, label: "Draft Policy" },
                { num: 2, label: "Simulate & Reflect" },
                { num: 3, label: "Synthesis" }
            ];
            
            return (
                <div className="bg-[#E0F7FA] brutal-border p-4 mb-8">
                    <h3 className="font-bold text-sm uppercase tracking-wider mb-4 flex items-center gap-2">
                        <Icon name="GitPullRequest" size={16} /> Council Workflow Status
                    </h3>
                    <div className="flex items-center relative px-4">
                        <div className="absolute left-4 right-4 top-1/2 h-1 bg-gray-300 -z-10 -translate-y-1/2"></div>
                        
                        {steps.map((s, idx) => (
                            <div key={idx} className={`flex flex-col items-center gap-2 flex-1 transition-opacity duration-300 ${step >= s.num ? 'opacity-100' : 'opacity-40'}`}>
                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm border-2 border-black ${step >= s.num ? 'bg-[#00A3E0] text-white' : 'bg-white text-gray-500'}`}>
                                    {step > s.num ? <Icon name="CheckCircle2" size={16} /> : s.num}
                                </div>
                                <span className={`text-xs font-bold bg-white px-2 py-1 border border-black ${step >= s.num ? 'text-black' : 'text-gray-500'}`}>
                                    {s.label}
                                </span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const LandingView = ({ setView }) => (
            <div className="max-w-5xl mx-auto px-4 py-12 animate-in fade-in duration-500">
                <div className="text-center mb-12">
                    <h1 className="text-4xl md:text-5xl font-black mb-4 uppercase tracking-tight">Policy Implementation <span className="text-[#00A3E0]">Sandbox</span></h1>
                    <p className="text-lg text-gray-600 max-w-2xl mx-auto">Test draft legislation against AI-simulated Cook County stakeholders to identify political friction, equity concerns, and economic impacts before public comment.</p>
                    
                    <button 
                        onClick={() => setView('simulator')}
                        className="mt-8 bg-[#00A3E0] text-white text-lg font-black px-8 py-4 brutal-border brutal-hover brutal-active transition-all flex items-center gap-3 mx-auto"
                    >
                        <Icon name="PlayCircle" size={24} /> Start New Simulation
                    </button>
                </div>

                <div className="mt-16">
                    <h2 className="text-xl font-black mb-6 flex items-center gap-2 border-b-2 border-black pb-2">
                        <Icon name="Briefcase" size={20} /> Recent Case Studies
                    </h2>
                    <div className="grid md:grid-cols-2 gap-6">
                        {MOCK_HISTORY.map(case_study => (
                            <div key={case_study.id} className="bg-white p-6 brutal-border group cursor-pointer hover:bg-gray-50 transition-colors" onClick={() => setView('simulator')}>
                                <div className="flex justify-between items-start mb-4">
                                    <span className={`text-xs font-bold px-2 py-1 border border-black uppercase ${case_study.status === 'Passed' ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800'}`}>
                                        {case_study.status}
                                    </span>
                                    <span className="text-xs font-mono text-gray-500">{case_study.date}</span>
                                </div>
                                <h3 className="font-bold text-lg mb-2 group-hover:text-[#00A3E0] transition-colors">{case_study.title}</h3>
                                <p className="text-sm text-gray-600 line-clamp-2">{case_study.summary}</p>
                                <div className="mt-4 flex items-center text-sm font-bold text-[#00A3E0]">
                                    Load Case <Icon name="ChevronRight" size={16} className="ml-1" />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const SimulatorView = ({ apiKey }) => {
            const [step, setStep] = useState(1);
            const [proposal, setProposal] = useState(DEMO_PROPOSAL);
            const [weights, setWeights] = useState({ env_dept: 1.0, perro: 1.0, ibew: 1.0, econ_dev: 1.0 });
            const [isSimulating, setIsSimulating] = useState(false);
            const [results, setResults] = useState(null);
            const [userReflection, setUserReflection] = useState("");
            const [error, setError] = useState(null);

            const handleWeightChange = (id, val) => setWeights(prev => ({ ...prev, [id]: val }));

            const runSimulation = async () => {
                if (!proposal.trim()) return;
                setIsSimulating(true);
                setError(null);

                if (!apiKey) {
                    // Demo Mode: Fake delay
                    setTimeout(() => {
                        setResults(DEMO_RESULT);
                        setIsSimulating(false);
                        setStep(2);
                    }, 2000);
                    return;
                }

                // Live API Mode
                try {
                    const systemPrompt = `You are a policy simulation engine for Cook County government. 
Evaluate this policy proposal: "${proposal}"
Against these stakeholders and their influence weights: ${JSON.stringify(weights)}.
Stakeholders: Environment Dept (Climate), PERRO (EJ Community), IBEW (Union), Econ Dev (Business).
Return a JSON object with this exact structure:
{
  "responses": [
    { "id": "env_dept", "stance": "approval"|"objection"|"skeptical"|"neutral", "score": 0-100, "content": "Reaction in their voice", "notes": "Private tactical note" },
    // ... same for perro, ibew, econ_dev
  ],
  "conflict": "1 sentence summarizing the main tension",
  "synthesis": "Educational synthesis explaining the trade-offs and possible strategies to resolve the conflict."
}`;

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: systemPrompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) throw new Error("API Request Failed. Check your key.");
                    const data = await response.json();
                    
                    const textContent = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!textContent) throw new Error("Invalid response format from API");
                    
                    const parsedResults = JSON.parse(textContent);
                    setResults(parsedResults);
                    setStep(2);
                } catch (err) {
                    console.error(err);
                    setError(err.message || "Simulation failed.");
                } finally {
                    setIsSimulating(false);
                }
            };

            const submitReflection = () => {
                if(userReflection.trim().length > 10) {
                    setStep(3);
                }
            };

            return (
                <div className="max-w-6xl mx-auto px-4 py-8">
                    <WorkflowStepper step={step} />

                    <div className="grid lg:grid-cols-3 gap-8">
                        {/* LEFT COL: Input & Configuration */}
                        <div className="lg:col-span-1 space-y-6">
                            <div className="bg-white p-6 brutal-border">
                                <h3 className="font-black text-lg mb-4 flex items-center gap-2 border-b-2 border-black pb-2">
                                    <Icon name="Building2" size={20} /> Policy Text
                                </h3>
                                <textarea 
                                    className="w-full h-40 p-3 bg-[#F8F9FA] border-2 border-gray-300 focus:border-[#00A3E0] outline-none text-sm resize-none mb-4 font-mono"
                                    placeholder="Draft your ordinance or policy text here..."
                                    value={proposal}
                                    onChange={(e) => setProposal(e.target.value)}
                                    disabled={step > 1}
                                />
                                
                                <h3 className="font-black text-lg mb-4 mt-6 flex items-center gap-2 border-b-2 border-black pb-2">
                                    <Icon name="Users" size={20} /> Influence Weights
                                </h3>
                                <p className="text-xs text-gray-500 mb-4">Adjust the political capital/influence of each stakeholder for this specific run.</p>
                                
                                <div className="space-y-4">
                                    {STAKEHOLDERS.map(s => (
                                        <div key={s.id} className="bg-gray-50 p-3 border border-gray-200">
                                            <div className="flex justify-between items-center mb-2">
                                                <span className="font-bold text-xs truncate pr-2">{s.role}</span>
                                                <span className="font-mono text-xs bg-white px-2 py-0.5 border border-gray-300">{(weights[s.id] * 100).toFixed(0)}%</span>
                                            </div>
                                            <input 
                                                type="range" min="0" max="2" step="0.1" 
                                                value={weights[s.id]} 
                                                onChange={(e) => handleWeightChange(s.id, parseFloat(e.target.value))} 
                                                disabled={step > 1}
                                                className="w-full accent-[#00A3E0] h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer" 
                                            />
                                        </div>
                                    ))}
                                </div>

                                {step === 1 && (
                                    <button 
                                        onClick={runSimulation}
                                        disabled={isSimulating || !proposal.trim()}
                                        className="w-full mt-6 bg-black text-white font-black py-4 brutal-border-sm brutal-hover brutal-active transition-all disabled:opacity-50 disabled:hover:transform-none flex justify-center items-center gap-2"
                                    >
                                        {isSimulating ? <Icon name="Loader2" className="animate-spin" /> : <Icon name="PlayCircle" />}
                                        {isSimulating ? "Running AI Simulation..." : "Run Simulation"}
                                    </button>
                                )}
                                {error && <div className="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 text-sm font-bold">{error}</div>}
                            </div>
                        </div>

                        {/* RIGHT COL: Output & Reflection */}
                        <div className="lg:col-span-2 space-y-6">
                            {step === 1 ? (
                                <div className="h-full border-4 border-dashed border-gray-300 flex flex-col items-center justify-center p-12 text-center text-gray-400 bg-gray-50">
                                    <Icon name="Bot" size={48} className="mb-4 opacity-50" />
                                    <h3 className="font-bold text-xl mb-2">Awaiting Input</h3>
                                    <p className="max-w-md">Draft your policy and configure stakeholder influence weights on the left, then click Run Simulation.</p>
                                </div>
                            ) : (
                                <div className="space-y-6 animate-in slide-in-from-right-8 duration-500">
                                    <div className="grid sm:grid-cols-2 gap-4">
                                        {STAKEHOLDERS.map(s => {
                                            const result = results?.responses?.find(r => r.id === s.id);
                                            if(!result) return null;
                                            
                                            const stanceColor = result.stance === 'approval' ? 'bg-emerald-100 border-emerald-500 text-emerald-800' :
                                                               result.stance === 'objection' ? 'bg-red-100 border-red-500 text-red-800' :
                                                               'bg-amber-100 border-amber-500 text-amber-800';

                                            return (
                                                <div key={s.id} className="bg-white brutal-border p-4 flex flex-col relative overflow-hidden">
                                                    <div className={`absolute top-0 right-0 w-2 h-full ${s.bg.replace('bg-', 'bg-').replace('50', '400')}`}></div>
                                                    <div className="flex justify-between items-start mb-3 pr-4">
                                                        <div className="flex items-center gap-2">
                                                            <div className={`p-1.5 ${s.bg} ${s.color} rounded border border-gray-200`}><Icon name={s.icon} size={16}/></div>
                                                            <h4 className="font-bold text-sm leading-tight">{s.role}</h4>
                                                        </div>
                                                        <span className={`text-[10px] font-bold uppercase px-2 py-0.5 border ${stanceColor}`}>
                                                            {result.stance}
                                                        </span>
                                                    </div>
                                                    <p className="text-sm text-gray-700 mb-4 flex-grow italic">"{result.content}"</p>
                                                    <div className="mt-auto bg-gray-50 border-t border-gray-200 p-2 text-xs font-mono text-gray-500">
                                                        <strong>Internal Note:</strong> {result.notes}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    {/* REFLECTION BLOCK */}
                                    {step === 2 && (
                                        <div className="bg-[#FFF9C4] brutal-border p-6 animate-in fade-in">
                                            <h3 className="font-black text-lg mb-2 flex items-center gap-2">
                                                <Icon name="Bot" /> Student Reflection Required
                                            </h3>
                                            <p className="text-sm text-gray-700 mb-4">
                                                Based on the simulated responses above, what is the core conflict? How would you adjust the policy to achieve consensus without gutting the original intent?
                                            </p>
                                            <textarea 
                                                className="w-full h-32 p-3 bg-white border-2 border-black focus:border-[#00A3E0] outline-none text-sm resize-none mb-4"
                                                placeholder="Write your synthesis and proposed compromise here..."
                                                value={userReflection}
                                                onChange={(e) => setUserReflection(e.target.value)}
                                            />
                                            <div className="flex justify-end">
                                                <button 
                                                    onClick={submitReflection}
                                                    disabled={userReflection.trim().length < 10}
                                                    className="bg-black text-white px-6 py-2 font-bold brutal-border-sm brutal-hover brutal-active transition-all disabled:opacity-50"
                                                >
                                                    Submit Synthesis
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {/* SYNTHESIS BLOCK */}
                                    {step === 3 && (
                                        <div className="space-y-6 animate-in slide-in-from-bottom-4">
                                            <div className="bg-white p-6 brutal-border border-l-8 border-l-[#00A3E0]">
                                                <h3 className="text-xs font-bold uppercase tracking-wider text-gray-500 mb-2">Your Synthesis</h3>
                                                <p className="text-sm text-gray-800 bg-gray-50 p-4 border border-gray-200">{userReflection}</p>
                                            </div>
                                            
                                            <div className="bg-gray-900 text-gray-100 p-6 brutal-border shadow-[4px_4px_0px_0px_rgba(0,163,224,1)]">
                                                <h3 className="font-black text-lg mb-4 text-[#00A3E0] flex items-center gap-2">
                                                    <Icon name="CheckCircle2" /> AI Coordinator's Model Answer
                                                </h3>
                                                <div className="space-y-4 text-sm leading-relaxed">
                                                    <div>
                                                        <strong className="text-white block mb-1">Identified Conflict:</strong>
                                                        <p className="text-gray-300">{results?.conflict}</p>
                                                    </div>
                                                    <div className="border-t border-gray-700 pt-4">
                                                        <strong className="text-white block mb-1">Strategic Synthesis:</strong>
                                                        <p className="text-gray-300 whitespace-pre-wrap">{results?.synthesis}</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <button onClick={() => setStep(1)} className="text-sm font-bold text-[#00A3E0] hover:text-black transition-colors flex items-center gap-1 mx-auto">
                                                <Icon name="Loader2" className="rotate-180" size={16}/> Start New Draft
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const MainApp = () => {
            const [view, setView] = useState('landing'); // 'landing' | 'simulator'
            const [showHelp, setShowHelp] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            
            // Initialize API key from local storage
            const [apiKey, setApiKeyState] = useState(() => {
                try {
                    return localStorage.getItem('cook_sim_api_key') || "";
                } catch(e) { return ""; }
            });

            // Sync API key to local storage
            const setApiKey = (key) => {
                setApiKeyState(key);
                try {
                    localStorage.setItem('cook_sim_api_key', key);
                } catch(e) { console.error("Could not save to localStorage"); }
            };

            return (
                <div className="min-h-screen flex flex-col">
                    <Header setView={setView} setShowHelp={setShowHelp} setShowSettings={setShowSettings} apiKey={apiKey} />
                    
                    <main className="flex-grow">
                        {view === 'landing' ? <LandingView setView={setView} /> : <SimulatorView apiKey={apiKey} />}
                    </main>

                    {showHelp && <HelpModal onClose={() => setShowHelp(false)} />}
                    {showSettings && <SettingsModal apiKey={apiKey} setApiKey={setApiKey} onClose={() => setShowSettings(false)} />}
                    
                    <footer className="bg-white border-t border-gray-200 py-6 mt-12">
                        <div className="max-w-7xl mx-auto px-4 text-center text-sm text-gray-500">
                            Cook County Academic Simulator (Demo) â€¢ For Educational Purposes Only
                        </div>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
